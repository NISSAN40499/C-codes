### BEFORE OPTIMIZATION
```
WITH FINANCIALS_CTE AS (
    SELECT *, 
        CASE 
            WHEN UNIT = 'THAUSANDS' THEN REVENUE / 1000
            WHEN UNIT = 'BILLIONS' THEN REVENUE * 1000
            WHEN UNIT = 'MILLIONS' THEN REVENUE
        END AS REVENUE_MLN,
        
        CASE 
            WHEN CURRENCY = 'USD' THEN
                CASE
                    WHEN UNIT = 'THAUSANDS' THEN (REVENUE / 1000) * 80
                    WHEN UNIT = 'BILLIONS' THEN (REVENUE * 1000) * 80
                    WHEN UNIT = 'MILLIONS' THEN REVENUE * 80
                END
            ELSE
                CASE
                    WHEN UNIT = 'THAUSANDS' THEN (REVENUE / 1000)
                    WHEN UNIT = 'BILLIONS' THEN (REVENUE * 1000)
                    WHEN UNIT = 'MILLIONS' THEN REVENUE
                END
        END AS REVENUE_INR,
        
        CASE
            WHEN UNIT = 'THAUSANDS' THEN BUDGET / 1000
            WHEN UNIT = 'BILLIONS' THEN BUDGET * 1000
            WHEN UNIT = 'MILLIONS' THEN BUDGET
        END AS BUDGET_MLN,
        
        CASE 
            WHEN CURRENCY = 'USD' THEN
                CASE
                    WHEN UNIT = 'THAUSANDS' THEN (BUDGET / 1000) * 80
                    WHEN UNIT = 'BILLIONS' THEN (BUDGET * 1000) * 80
                    WHEN UNIT = 'MILLIONS' THEN BUDGET * 80
                END
            ELSE
                CASE
                    WHEN UNIT = 'THAUSANDS' THEN (BUDGET / 1000)
                    WHEN UNIT = 'BILLIONS' THEN (BUDGET * 1000)
                    WHEN UNIT = 'MILLIONS' THEN BUDGET
                END
        END AS BUDGET_INR
    FROM FINANCIALS
)

SELECT *,
    (BUDGET_INR / REVENUE_INR) * 100 AS PROFIT_PCT
FROM FINANCIALS_CTE;

```

### OPTIMIZAED CTE QUERY

```
WITH financials_cte AS (
    SELECT 
        *,
        CASE 
            WHEN UNIT = 'THAUSANDS' THEN REVENUE / 1000
            WHEN UNIT = 'BILLIONS' THEN REVENUE * 1000
            ELSE REVENUE
        END AS revenue_mln,

        CASE 
            WHEN UNIT = 'THAUSANDS' THEN BUDGET / 1000
            WHEN UNIT = 'BILLIONS' THEN BUDGET * 1000
            ELSE BUDGET
        END AS budget_mln
    FROM financials
),
conversion_cte AS (
    SELECT 
        *,
        CASE 
            WHEN CURRENCY = 'USD' THEN revenue_mln * 80
            ELSE revenue_mln
        END AS revenue_inr,

        CASE 
            WHEN CURRENCY = 'USD' THEN budget_mln * 80
            ELSE budget_mln
        END AS budget_inr
    FROM financials_cte
)
SELECT 
    *,
    ROUND((budget_inr / NULLIF(revenue_inr, 0)) * 100, 2) AS profit_pct
FROM conversion_cte;
```



### JOINS IN SQL
```
SELECT *
FROM movies
JOIN FINANCIALS
ON MOVIES.MOVIE_ID = FINANCIALS.MOVIE_ID;
```

### MOVIE_ID IS THE SAME IN BOTH TABLE THAT IS WHY WE NEED TO SPECIFY IT USING MOVIES.MOVIE_ID

#### INNER JOIN 
```
SELECT 
	MOVIES.MOVIE_ID, TITLE, CURRENCY, BUDGET, UNIT
FROM MOVIES
JOIN
	FINANCIALS
    ON MOVIES.MOVIE_ID = FINANCIALS.MOVIE_ID;
```
#### Same same but different style
```
SELECT
M.MOVIE_ID, TITLE, CURRENCY, UNIT
FROM MOVIES M 
INNER JOIN FINANCIALS F 
ON M.MOVIE_ID =F.MOVIE_ID;
```

### LEFT JOIN
```
SELECT
M.MOVIE_ID, TITLE, CURRENCY, UNIT
FROM MOVIES M 
LEFT JOIN FINANCIALS F 
ON M.MOVIE_ID =F.MOVIE_ID;
```
### RIGHT JOIN 
```
SELECT
F.MOVIE_ID, TITLE, CURRENCY, UNIT
FROM MOVIES M 
RIGHT JOIN FINANCIALS F 
ON M.MOVIE_ID =F.MOVIE_ID;
```
### FULL JOIN 
```
SELECT
M.MOVIE_ID, TITLE, CURRENCY, UNIT
FROM MOVIES M 
LEFT JOIN FINANCIALS F 
ON M.MOVIE_ID =F.MOVIE_ID

UNION 

SELECT
F.MOVIE_ID, TITLE, CURRENCY, UNIT
FROM MOVIES M 
RIGHT JOIN FINANCIALS F 
ON M.MOVIE_ID =F.MOVIE_ID;
```
### USING --------------- THIS CAN BE USED TO JOIN BASED ON MULTIPLE COLUMNS -----------------------
```
SELECT
MOVIE_ID, TITLE, CURRENCY, UNIT
FROM MOVIES
RIGHT JOIN FINANCIALS
USING(MOVIE_ID);
```
### 1. Show all the movies with their language names
```
SELECT * 
FROM movies
JOIN LANGUAGES
ON MOVIES.LANGUAGE_ID = LANGUAGES.LANGUAGE_ID;
```
### 2. Show all Telugu movie names (assuming you don't know the languageid for Telugu)
```
SELECT MOVIES.TITLE
FROM movies
JOIN LANGUAGES
ON MOVIES.LANGUAGE_ID = LANGUAGES.LANGUAGE_ID
WHERE  LANGUAGES.NAME LIKE "%TELUGU%";
```
### 3.Show the language and number of movies released in that language
```
SELECT 
LANGUAGES.NAME,
COUNT(MOVIES.LANGUAGE_ID)
FROM MOVIES
JOIN LANGUAGES
ON MOVIES.LANGUAGE_ID = LANGUAGES.LANGUAGE_ID
WHERE LANGUAGES.NAME LIKE "%TELUGU%"
GROUP BY LANGUAGES.NAME;
```

### CROSS JOIN - CARTESIAN PRODUCT X * X
```
USE FOOD_DB;

SELECT *,
CONCAT(NAME, " ", VARIANT_NAME) AS FULL_NAME,
(PRICE+VARIANT_PRICE) AS FULL_PRICE
FROM food_db.ITEMS
CROSS JOIN VARIANTS;
    *,
    ROUND((budget_inr / NULLIF(revenue_inr, 0)) * 100, 2) AS profit_pct
FROM conversion_cte;
```

### SUBQUERIES 
```
SELECT * 
	FROM MOVIES 
    WHERE iMDB_RATING = (SELECT MAX(IMDB_RATING) AS MAX_IMDB_RATING FROM MOVIES);
```
### With 2 aggregated columns

```    
SELECT *
	FROM MOVIES 
    WHERE IMDB_RATING IN (
    (SELECT MIN(IMDB_RATING)AS MIN_RATING FROM MOVIES), 
    (SELECT MAX(IMDB_RATING)AS MAX_RATING FROM MOVIES)
    );

```

### THIS TWO CODE WILL DOES THE SAME, FIRST ONE IS USED SUBQUERY AND SECOND ONE IS USING HAVING CLAUSE.
```
 SELECT * FROM
(SELECT
    NAME,
    YEAR(CURDATE()) - BIRTH_YEAR AS AGE
FROM ACTORS) AS ACTORS_AGE
WHERE AGE > 70 AND AGE < 85
ORDER BY AGE DESC;
    

SELECT
	NAME,
    YEAR(CURDATE())-BIRTH_YEAR AS AGE
FROM ACTORS
HAVING AGE > 70 AND AGE < 85
ORDER BY AGE DESC;
```

### ANY 
```
SELECT * 
FROM ACTORS 
WHERE ACTOR_ID = ANY
(SELECT
	ACTOR_ID 
FROM MOVIE_ACTOR 
	WHERE MOVIE_ID IN (101,110,121));

```

### IN (any, in will do the same here)
```
 SELECT *
 FROM ACTORS
 WHERE ACTOR_ID IN
(SELECT
	ACTOR_ID
FROM MOVIE_ACTOR
 WHERE MOVIE_ID IN (101,110,121));   
```
### SHOWS IMDB RATING FOR MOVIES GREATER THAN MARVEL STUDIO MOVIES RATING 
```
SELECT * FROM
MOVIES WHERE IMDB_RATING > ANY
(SELECT IMDB_RATING
FROM MOVIES 
WHERE STUDIO = "MARVEL STUDIOS");
```
### SOME
```
SELECT * FROM
MOVIES WHERE IMDB_RATING > SOME
(SELECT IMDB_RATING
FROM MOVIES 
WHERE STUDIO = "MARVEL STUDIOS");
``` 
### CO-RELATED SUBQUERY 
```
EXPLAIN ANALYZE
SELECT
	ACTOR_ID,
    NAME,
    (SELECT COUNT(*) FROM MOVIE_ACTOR
    WHERE ACTOR_ID = ACTORS.ACTOR_ID) AS MOVIES_COUNT -- HERE SUBQUERY IS REFERING AN OUTER TABLE NAMED ACTORS AND THUS IT IS CALLED CO-RELATED SUBQUERY
FROM ACTORS
ORDER BY MOVIES_COUNT DESC;
```

### WE CAN ACHIEVE THE SAME USING JOINS
```
EXPLAIN ANALYZE
SELECT
	ACTORS.ACTOR_ID,
    ACTORS.NAME,
    COUNT(*) AS MOVIES_COUNT
FROM MOVIE_ACTOR
JOIN ACTORS ON
MOVIE_ACTOR.ACTOR_ID = ACTORS.ACTOR_ID
GROUP BY ACTOR_ID
ORDER BY MOVIES_COUNT DESC; 
``` 
### HERE WE CAN SEE CO-RELATED QUERY IS PERFORMING BETTER! 

### Excercises 
```
-- 1. Select all the movies with minimum and maximum release_year. Note that there can be more than one movie in min and a max year hence output rows can be more than 2

SELECT * 
	FROM MOVIES 
WHERE RELEASE_YEAR IN (
(SELECT MIN(RELEASE_YEAR) AS MIN_RELEASE_YEAR FROM MOVIES),
(SELECT MAX(RELEASE_YEAR) AS MAX_RELEASE_YEAR FROM MOVIES)
);

```
```
-- 2. Select all the rows from the movies table whose imdb_rating is higher than the average rating

SELECT *
	FROM MOVIES
WHERE IMDB_RATING > 
(SELECT AVG(IMDB_RATING) AS AVG_IMDB
FROM MOVIES);
```

### CTE COMMON TABLE EXPRESSION 

```
-- GET ALL ACTORS WHOSE AGE IS BETWEEN 70 AND 85

WITH ACTORS_AGE AS(
SELECT
	NAME AS ACTORS_NAME,
    YEAR(CURDATE())-BIRTH_YEAR AS AGE
FROM ACTORS
)
SELECT 
	ACTORS_NAME,
    AGE
FROM ACTORS_AGE
WHERE AGE >70 AND AGE <85;
```

### MOVIES THAT PRODUCES 100000 MORE PROFIT AND THEIR  RATING WAS LESS THAN AVG RATING FOR ALL MOVIES

```
WITH FINANCIALS_CAL AS (
SELECT 
	MOVIE_ID,
    CURRENCY,
	CASE 
		WHEN UNIT = "THOUSANDS" THEN (REVENUE-BUDGET) /1000
        WHEN UNIT = "BILLIONS" THEN (REVENUE-BUDGET) * 1000 
        ELSE (REVENUE-BUDGET)
    END AS PROFIT_MLN
FROM FINANCIALS
),
    
CONVERTED_PROFIT AS(
SELECT
	MOVIE_ID,
    CASE
		WHEN CURRENCY = "USD" THEN ROUND(PROFIT_MLN * 84.31, 2)
        WHEN CURRENCY = "EURO" THEN ROUND(PROFIT_MLN * 94.61,2 )
        ELSE ROUND(PROFIT_MLN, 2)
	END AS PROFIT_INR_MLN
FROM FINANCIALS_CAL
),

AVG_RATING AS(
SELECT * 
	FROM MOVIES 
WHERE IMDB_RATING <
	(SELECT AVG(IMDB_RATING) AS AVG_RTG FROM MOVIES)
)

SELECT 
	AVG_RATING.MOVIE_ID,
    AVG_RATING.TITLE,
    AVG_RATING.IMDB_RATING,
    CONVERTED_PROFIT.PROFIT_INR_MLN
FROM AVG_RATING
JOIN CONVERTED_PROFIT ON
AVG_RATING.MOVIE_ID = CONVERTED_PROFIT.MOVIE_ID
WHERE CONVERTED_PROFIT.PROFIT_INR_MLN >= 100000;
```

### MOVIES THAT PRODUCES 500% MORE PROFIT AND THEIR  RATING WAS LESS THAN AVG RATING FOR ALL MOVIES

```
WITH X AS (
SELECT *,
	((REVENUE - BUDGET)*100)/BUDGET AS PCT_PROFIT
FROM FINANCIALS
),

Y AS(
SELECT *
FROM MOVIES
WHERE IMDB_RATING <
(SELECT 
AVG(IMDB_RATING) AS AVG_RTG
FROM MOVIES)
)

SELECT
	X.MOVIE_ID,
    X.PCT_PROFIT,
    Y.TITLE,
    Y.IMDB_RATING
FROM X
JOIN Y ON
X.MOVIE_ID = Y.MOVIE_ID
WHERE X.PCT_PROFIT >= 500;
```


### Select all Hollywood movies released after the year 2000 that made more than 500 million $ profit or more profit in desc order.
```
WITH X AS (
SELECT * 
FROM MOVIES
WHERE INDUSTRY = "HOLLYWOOD"
),
Y AS (
SELECT *,
	(REVENUE - BUDGET) AS PROFIT
FROM FINANCIALS
)
SELECT *
	FROM X
JOIN Y ON
X.MOVIE_ID = Y.MOVIE_ID
WHERE X.RELEASE_YEAR >2000 AND Y.PROFIT > 500
ORDER BY Y.PROFIT DESC;
```

